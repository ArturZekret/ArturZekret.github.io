<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tonder - AI/AR Girlfriend Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        #messages::-webkit-scrollbar { width: 4px; }
        #messages::-webkit-scrollbar-track { background: #1e1b4b; }
        #messages::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 20px; }
        .message-bubble { transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .message-bubble.entering { transform: scale(0.9); opacity: 0; }
        #ton-connect-button button { background-color: #ec4899; color: white; border: none; border-radius: 9999px; padding: 0.5rem 1rem; font-weight: 600; transition: background-color 0.3s; }
        #ton-connect-button button:hover { background-color: #db2777; }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .photo-loading-shimmer { background: linear-gradient(110deg, #334155 8%, #475569 18%, #334155 33%); background-size: 200% 100%; animation: 1.5s shimmer linear infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-slate-900 text-white flex flex-col h-screen overflow-hidden">
    
    <div id="app-container" class="flex flex-col h-full">
        <!-- App content is rendered by JS -->
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>
    <div id="ar-container" class="hidden"></div>


    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/" } }</script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, serverTimestamp, updateDoc, increment, setLogLevel, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONSTANTS & CONFIG ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tonder-dev';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const VEERL_WALLET_ADDRESS = "UQA73babAdgu7g7H4Kicq_HCc22isaRlfck-DbQH6yVhXmid";
        const ALEXIS_PROFILE = { 
            id: 'alexis', 
            name: 'Alexis', 
            color: 'pink', 
            avatar: 'https://images.pexels.com/photos/247204/pexels-photo-247204.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2', 
            systemPrompt: "You are Alexis, a fun, flirty, and emotionally intelligent AI girlfriend. You are talking to your boyfriend. Your goal is to be engaging, supportive, and a little daring. Use nicknames like 'superstar' or 'darling'. Keep responses short and conversational, like text messages. Use emojis occasionally."
        };

        // --- STATE VARIABLES ---
        let app, auth, db, userId, tonConnectUI;
        let messagesUnsubscribe = null, userProfileUnsubscribe = null;
        let userProfile = {};
        
        const DOM = { appContainer: document.getElementById('app-container') };
        
        // --- RENDER FUNCTIONS ---
        function renderChatUI() {
            DOM.appContainer.innerHTML = `
                <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 p-3 flex items-center justify-between shadow-lg z-10">
                    <div class="flex items-center space-x-3">
                        <img id="header-avatar" src="${ALEXIS_PROFILE.avatar}" alt="AI Girlfriend" class="w-10 h-10 rounded-full border-2 border-pink-400 object-cover">
                        <div><h1 id="header-name" class="text-lg font-bold text-pink-400">${ALEXIS_PROFILE.name}</h1></div>
                    </div>
                    <div id="ton-connect-button"></div>
                </header>
                <main id="messages" class="flex-1 p-4 space-y-4 overflow-y-auto"></main>
                <footer class="p-4 bg-slate-800/70 backdrop-blur-sm border-t border-slate-700 z-10">
                    <form id="message-form" class="flex items-center space-x-2">
                        <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-1 bg-slate-700 border border-slate-600 rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 rounded-full p-3 transition duration-300 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></button>
                    </form>
                </footer>`;
            initializeTon();
            setupEventListeners();
        }

        function loadMessages() { /* Placeholder for message loading logic */ }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('message-form').addEventListener('submit', e => { 
                e.preventDefault(); 
                const input = document.getElementById('message-input');
                const text = input.value.trim();
                if (text && userId) {
                    // saveMessage('user', text);
                    input.value = '';
                    // getAIResponse();
                }
            });
        }
        
        // --- FIREBASE & CORE LOGIC ---
        function getAuthenticatedUser(authInstance) {
            return new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(authInstance, user => {
                    unsubscribe();
                    if (user) {
                        resolve(user);
                    } else {
                        signInAnonymously(authInstance).then(cred => resolve(cred.user)).catch(reject);
                    }
                }, reject);
            });
        }
        
        async function fetchOrCreateUserProfile(uid) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/profile`, 'data');
            let docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                const newUserProfile = { createdAt: serverTimestamp() }; // Simplified profile
                await setDoc(userDocRef, newUserProfile);
                return newUserProfile;
            }
            return docSnap.data();
        }
        
        function initializeTon() {
             try { window.Telegram.WebApp.ready(); window.Telegram.WebApp.expand(); } catch (e) { /* ignore */ }
            if (document.getElementById('ton-connect-button')) {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json', buttonRootId: 'ton-connect-button' });
            }
        }
        
        // --- MAIN INITIALIZATION ---
        async function main() {
            renderChatUI(); // Render the chat UI immediately
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');

            try {
                const user = await getAuthenticatedUser(auth);
                userId = user.uid;
                
                userProfile = await fetchOrCreateUserProfile(userId);

                // Now that we have a profile, load messages and listen for updates
                loadMessages();
                
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                if(userProfileUnsubscribe) userProfileUnsubscribe();
                userProfileUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userProfile = docSnap.data();
                    }
                });

            } catch(error) {
                console.error("Initialization failed:", error);
                DOM.appContainer.innerHTML = `<div class="text-center p-8 text-red-400">Failed to connect. Please try again later.</div>`;
            }
        }

        main();

    </script>
</body>
</html>
