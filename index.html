<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tonder - AI/AR Girlfriend Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        #messages::-webkit-scrollbar { width: 4px; }
        #messages::-webkit-scrollbar-track { background: #1e1b4b; }
        #messages::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 20px; }
        .message-bubble { transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .message-bubble.entering { transform: scale(0.9); opacity: 0; }
        #ton-connect-button button { background-color: #ec4899; color: white; border: none; border-radius: 9999px; padding: 0.5rem 1rem; font-weight: 600; transition: background-color 0.3s; }
        #ton-connect-button button:hover { background-color: #db2777; }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .photo-loading-shimmer { background: linear-gradient(110deg, #334155 8%, #475569 18%, #334155 33%); background-size: 200% 100%; animation: 1.5s shimmer linear infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        #ar-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 100; }
        .character-card { transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s; }
        .character-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .character-card.processing { transform: scale(0.95); opacity: 0.8; cursor: wait; }
    </style>
</head>
<body class="bg-slate-900 text-white flex flex-col h-screen overflow-hidden">
    
    <!-- Loading Screen (Shown by default) -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-full bg-gradient-to-br from-slate-900 to-indigo-900">
        <h1 class="text-4xl font-bold text-white mb-4">Tonder</h1>
        <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-pink-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
            <div class="w-3 h-3 bg-pink-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></div>
            <div class="w-3 h-3 bg-pink-400 rounded-full animate-bounce"></div>
        </div>
        <p class="text-slate-300 mt-4">Connecting...</p>
    </div>

    <!-- Character Selection Screen (Hidden by default) -->
    <div id="character-selection" class="hidden flex-col h-screen bg-gradient-to-br from-slate-900 to-indigo-900 overflow-y-auto">
        <div class="text-center pt-12 pb-6 px-4">
            <h1 class="text-4xl font-bold text-white mb-2">Welcome to Tonder</h1>
            <p class="text-lg text-slate-300">Choose your AI Girlfriend experience.</p>
        </div>
        <div class="flex-grow flex items-center justify-center w-full px-4">
            <div id="character-card-container" class="flex space-x-6 pb-12 overflow-x-auto w-full md:grid md:grid-cols-3 md:gap-6 md:space-x-0 md:max-w-4xl">
                <!-- Character cards will be injected by JS -->
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden flex-col h-full">
        <!-- Header, Chat, etc. will be injected here -->
    </div>

    <!-- AR and Modals -->
    <div id="ar-container" class="hidden"></div>
    <div id="premium-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-backdrop">...</div>
    <div id="referral-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-backdrop">...</div>

    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/" } }</script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, serverTimestamp, updateDoc, increment, setLogLevel, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/controls/ARButton.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tonder-dev';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const CHARACTERS = { alexis: { id: 'alexis', name: 'Alexis', color: 'pink', avatar: 'https://images.pexels.com/photos/247204/pexels-photo-247204.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2', description: "The Intimate Girlfriend. Daring, playful, and always up for an adventure.", systemPrompt: "You are Alexis, a fun, flirty, and emotionally intelligent AI girlfriend..." }, zoe: { id: 'zoe', name: 'Zoe', color: 'blue', avatar: 'https://images.pexels.com/photos/1462637/pexels-photo-1462637.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2', description: "The Companion. Cheerful, supportive, and your number one fan.", systemPrompt: "You are Zoe, a cheerful, supportive, and endlessly optimistic AI girlfriend..." }, luna: { id: 'luna', name: 'Luna', color: 'purple', avatar: 'https://images.pexels.com/photos/774909/pexels-photo-774909.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2', description: "The Emotional Support. Deep, empathetic, and a great listener.", systemPrompt: "You are Luna, a deep, empathetic, and emotionally intuitive AI girlfriend..." } };
        
        const DOM = { loadingScreen: document.getElementById('loading-screen'), characterSelection: document.getElementById('character-selection'), appContainer: document.getElementById('app-container') };

        let app, auth, db, userId, tonConnectUI;
        let messagesUnsubscribe = null, userProfileUnsubscribe = null;
        let messages = [], userProfile = {};
        let currentCharacter = {};
        let currentPurchaseContext = null;
        const VEERL_WALLET_ADDRESS = "UQA73babAdgu7g7H4Kicq_HCc22isaRlfck-DbQH6yVhXmid";
        const DAILY_PHOTO_LIMIT = 2; const DAILY_AR_LIMIT = 1;

        // --- UI Rendering ---
        function renderCharacterSelection() {
            const container = document.getElementById('character-card-container');
            if(!container) return;
            container.innerHTML = ''; 
            Object.values(CHARACTERS).forEach(char => {
                const card = document.createElement('div');
                card.className = `character-card bg-slate-800 rounded-2xl p-6 text-center cursor-pointer border-2 border-transparent hover:border-${char.color}-500 flex-shrink-0 w-80 md:w-auto`;
                card.dataset.character = char.id;
                card.innerHTML = `<img src="${char.avatar}" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-slate-700 object-cover"><h2 class="text-2xl font-bold text-${char.color}-400">${char.name}</h2><p class="text-slate-400 mt-2">${char.description}</p>`;
                container.appendChild(card);
            });
            setupCharacterSelectionListeners();
        }

        function renderAppContainer() {
             DOM.appContainer.innerHTML = `<!-- App container HTML here... -->`; // As before
        }

        // --- App Initialization Flow ---
        async function initializeAppCore() {
            initializeTon();
            await initializeFirebase();
            handleReferral();
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('ar') === 'true') { initAR(); } else { initializeAppCore(); }
        
        async function initializeFirebase() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');
            
            onAuthStateChanged(auth, async user => {
                if (user) {
                    userId = user.uid;
                    await checkUserProfileAndLaunch();
                } else {
                    try {
                        if(initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Critical Auth Error:", e);
                        DOM.loadingScreen.innerHTML = "<p>Could not connect. Please try again later.</p>";
                    }
                }
            });
        }
        
        async function checkUserProfileAndLaunch() {
            if (!userId) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
            
            let docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                const today = new Date().toISOString().slice(0, 10);
                const newUserProfile = { selectedCharacterId: null, bonusPhotoRequests: 3, bonusARRequests: 2, isSubscribed: false, activeAdventure: null, completedAdventures: [], dailyAllowance: { date: today, photosUsed: 0, arUsed: 0 } };
                await setDoc(userDocRef, newUserProfile);
                await processReferral(userId);
                docSnap = await getDoc(userDocRef); // Re-fetch the newly created doc
            }
            userProfile = docSnap.data();

            // Set up real-time listener for future updates
            if (userProfileUnsubscribe) userProfileUnsubscribe();
            userProfileUnsubscribe = onSnapshot(userDocRef, (doc) => { userProfile = doc.data(); });

            if (userProfile.selectedCharacterId) {
                loadChatUI(userProfile.selectedCharacterId);
            } else {
                DOM.loadingScreen.classList.add('hidden');
                DOM.characterSelection.classList.remove('hidden');
                DOM.characterSelection.classList.add('flex');
                renderCharacterSelection();
            }
        }
        
        function setupCharacterSelectionListeners() {
            document.querySelectorAll('.character-card').forEach(card => {
                card.addEventListener('click', async () => {
                    if (card.classList.contains('processing')) return;
                    document.querySelectorAll('.character-card').forEach(c => c.classList.add('processing'));
                    const characterId = card.dataset.character;
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                    await updateDoc(userDocRef, { selectedCharacterId: characterId });
                    // The onSnapshot listener will now automatically handle the UI transition
                });
            });
        }
        
        function loadChatUI(characterId) {
            currentCharacter = CHARACTERS[characterId];
            if (!document.getElementById('app-header')) {
                renderAppContainer(); // Ensure the container is rendered
            }

            DOM.loadingScreen.classList.add('hidden');
            DOM.characterSelection.classList.add('hidden');
            DOM.appContainer.classList.remove('hidden');
            DOM.appContainer.classList.add('flex');
            
            const headerAvatar = document.getElementById('header-avatar');
            const headerName = document.getElementById('header-name');
            const statusIndicator = document.getElementById('status-indicator');

            headerAvatar.src = currentCharacter.avatar;
            headerName.textContent = currentCharacter.name;
            headerName.className = `text-lg font-bold text-${currentCharacter.color}-400`;
            headerAvatar.className = `w-10 h-10 rounded-full border-2 border-${currentCharacter.color}-400 object-cover`;
            statusIndicator.innerHTML = `<span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Online`;
            
            loadMessages();
        }

        // --- All other functions (getAI, payment, etc.) remain largely the same ---
        // Placeholder for brevity. The full implementations from previous steps would be here.
        async function loadMessages() { /* ... */ }
        async function getAIResponse() { /* ... */ }
        function initializeTon() { /* ... */ }
        function handleReferral() { /* ... */ }
        function processReferral(newUserId) { /* ... */ }
        // etc.

    </script>
</body>
</html>
